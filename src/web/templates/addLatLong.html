<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Lat Long em Massa de uma Lista de CEPs</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <header class="header text-center">
            <h1 class="display-4 fw-bold">Buscar Lat Long em Massa de uma Lista de CEPs</h1>
            <p class="lead">Processe um arquivo CSV com múltiplos CEPs e obtenha coordenadas para todos</p>
            <a href="/" class="btn btn-menu mt-3">
                <i class="bi bi-arrow-left me-2"></i>Voltar à Página Inicial
            </a>
        </header>

        <!-- Área principal -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title"><i class="bi bi-upload me-2"></i>Enviar Arquivo CSV</h4>
                        <p class="card-text">
                            Faça upload de um arquivo CSV contendo uma coluna <code>Cep-Ini</code> com os CEPs a serem processados.
                            O sistema consultará a API para cada CEP e adicionará as colunas <code>Lat</code> e <code>Long</code>.
                        </p>

                        <!-- Formulário de upload -->
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="bi bi-cloud-arrow-up"></i>
                            </div>
                            <h5>Arraste e solte seu arquivo CSV aqui</h5>
                            <p class="text-muted">ou clique para selecionar</p>
                            
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                                </div>
                                <button type="submit" class="btn btn-primary-custom btn-lg" id="submitBtn">
                                    <i class="bi bi-gear me-2"></i>Processar Arquivo
                                </button>
                            </form>
                        </div>

                        <!-- Requisitos do arquivo -->
                        <div class="mt-4">
                            <h5><i class="bi bi-file-earmark-text me-2"></i>Requisitos do Arquivo CSV</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-check-circle text-success me-2"></i>Formato Esperado</h6>
                                            <ul class="mb-0">
                                                <li>Delimitador: ponto‑e‑vírgula (<code>;</code>)</li>
                                                <li>Encoding: Latin‑1 (suporta acentos)</li>
                                                <li>Coluna obrigatória: <code>Cep-Ini</code></li>
                                                <li>Colunas opcionais: <code>No</code>, <code>Bairro</code></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="bi bi-exclamation-triangle text-warning me-2"></i>Exemplo</h6>
                                            <pre class="mb-0 small">No;Bairro;Cep-Ini
1;Abolição;20750-000
2;Acari;21530-014
3;Água Santa;20740-590</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Área de resultados (inicialmente oculta) -->
                        <div id="resultArea" class="mt-5" style="display: none;">
                            <h5><i class="bi bi-check-circle text-success me-2"></i>Processamento Concluído</h5>
                            <div class="alert alert-success alert-custom">
                                <i class="bi bi-info-circle me-2"></i>
                                O arquivo foi processado com sucesso! As coordenadas foram adicionadas.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Informações do Processamento</h6>
                                            <p><strong>Arquivo original:</strong> <span id="originalFilename"></span></p>
                                            <p><strong>Arquivo processado:</strong> <span id="processedFilename"></span></p>
                                            <p><strong>Status:</strong> <span class="badge bg-success">Concluído</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6>Download do Resultado</h6>
                                            <p class="mb-3">Clique no botão abaixo para baixar o arquivo com as coordenadas.</p>
                                            <a href="#" class="btn btn-success btn-lg" id="downloadBtn">
                                                <i class="bi bi-download me-2"></i>Baixar Arquivo
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-repeat me-2"></i>Processar Outro Arquivo
                                </button>
                            </div>
                        </div>

                        <!-- Área de erro (inicialmente oculta) -->
                        <div id="errorArea" class="mt-5" style="display: none;">
                            <h5><i class="bi bi-exclamation-triangle text-danger me-2"></i>Erro no Processamento</h5>
                            <div class="alert alert-danger alert-custom">
                                <i class="bi bi-x-circle me-2"></i>
                                <span id="errorMessage">Ocorreu um erro ao processar o arquivo.</span>
                            </div>
                            <button class="btn btn-outline-danger" onclick="resetForm()">
                                <i class="bi bi-arrow-repeat me-2"></i>Tentar Novamente
                            </button>
                        </div>

                        <!-- Informações adicionais -->
                        <div class="mt-5">
                            <h5><i class="bi bi-question-circle me-2"></i>Como Funciona</h5>
                            <div class="accordion" id="accordionExample">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                            Processamento em Massa
                                        </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse show">
                                        <div class="accordion-body">
                                            <p>O sistema lê cada linha do arquivo CSV, consulta a API Brasil Aberto para obter as coordenadas geográficas (latitude e longitude) e adiciona essas informações ao arquivo.</p>
                                            <p><strong>Observação:</strong> CEPs inválidos ou não encontrados terão as colunas <code>Lat</code> e <code>Long</code> deixadas em branco.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                            Segurança dos Dados
                                        </button>
                                    </h2>
                                    <div id="collapseTwo" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <p>O arquivo original é armazenado temporariamente no servidor e excluído após o processamento. O arquivo resultante é mantido por um período limitado.</p>
                                            <p>Nenhum dado pessoal é coletado ou armazenado permanentemente.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <footer class="footer text-center mt-5">
            <p class="mb-0">© 2025 Sistema de Pesquisa de CEP, Coordenadas, Endereços e Distâncias</p>
            <p class="small">Processamento em massa via API Brasil Aberto</p>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Manipulação do formulário
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            
            if (!fileInput.files.length) {
                alert('Por favor, selecione um arquivo CSV.');
                return;
            }
            
            // Mostra estado de carregamento
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processando...';
            
            const formData = new FormData();
            formData.append('csv_file', fileInput.files[0]);
            
            try {
                const response = await fetch('/add-lat-long', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mostra área de resultados
                    document.getElementById('originalFilename').textContent = result.original_filename;
                    document.getElementById('processedFilename').textContent = result.download_filename;
                    
                    // Configura link de download
                    document.getElementById('downloadBtn').href = `/download/${result.download_filename}`;
                    
                    // Esconde formulário, mostra resultados
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('errorArea').style.display = 'none';
                } else {
                    // Mostra erro
                    document.getElementById('errorMessage').textContent = result.error || 'Erro desconhecido';
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'none';
                    document.getElementById('errorArea').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Erro de conexão com o servidor.';
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('resultArea').style.display = 'none';
                document.getElementById('errorArea').style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
        
        // Função para resetar o formulário
        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('errorArea').style.display = 'none';
        }
        
        // Efeito visual no área de upload
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e9ecef';
            uploadArea.style.borderColor = '#5a0cb9';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
            
            const fileInput = document.getElementById('csvFile');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
            }
        });
    </script>
</body>
</html>
